% Non-monotone system
a = [7.808814546977573e-03 6.024889141455351e-02 4.753465313252995e-03 -1.077887353268151e-03 5.937173055460279e-02 3.740829642902648e-01 1.452215038440278e-01 -2.213361509437079e-02 1.915536407011988e-02 2.346944529331235e-01 1.700770487153318e-01 -1.802614034811699e-02 -2.471758915518383e-03 -2.308050218915807e-02 -1.026619813978539e-02 1.641866357961972e-03 ;2.634489084456162e-04 1.048312867713732e-03 1.007159493737193e-01 2.742339177492747e-02 1.289821494488291e-02 -3.967983857610475e-02 4.282149630224648e-01 1.758785033286145e-01 1.265744808092877e-02 -4.210061490643794e-02 1.980382628925191e-01 1.399447886149824e-01 -7.081958314766133e-04 2.565481756252918e-03 -1.113038815942403e-02 -6.029728092009162e-03 ;1.900245985974602e-03 -6.164175543894198e-03 2.385790390279226e-02 2.409491085178304e-02 -6.145189022499844e-03 1.993601138519648e-02 -7.723540933730039e-02 -7.777083289022078e-02 2.283114583427538e-02 -7.412829671722106e-02 2.898018918094221e-01 2.836322449688228e-01 2.468899768759850e-02 -7.986921894180678e-02 2.997199766998732e-01 3.308497933272037e-01 ;3.616514531976320e-03 2.250608137353545e-02 1.576198170549448e-02 -9.451563298612796e-04 -1.196636457342956e-02 -7.375376268737571e-02 -5.122477092179624e-02 3.101841984229665e-03 7.504749047402150e-02 3.522654277614097e-01 1.985843749012538e-01 -1.182912133934980e-02 3.767809516972354e-02 2.499738366255118e-01 2.008716809589432e-01 -9.688149634287706e-03 ];

% Monotone system
%a = [8.630988601095266e-03 6.350562272472474e-02 1.871954337567344e-02 0.000000000000000e+00 6.503746247475795e-02 3.058122439923318e-01 1.303674742777282e-01 0.000000000000000e+00 3.610442068872938e-02 2.141220767847338e-01 1.571779363393185e-01 0.000000000000000e+00 0.000000000000000e+00 8.185422378460460e-05 4.403765171213940e-04 0.000000000000000e+00 ;0.000000000000000e+00 7.334654539775142e-03 9.679073540033981e-02 2.857814571024443e-02 0.000000000000000e+00 1.629581294076938e-02 3.889900217774671e-01 1.258334048921130e-01 0.000000000000000e+00 6.983587521487126e-04 2.236015314148270e-01 1.104100446080136e-01 0.000000000000000e+00 0.000000000000000e+00 9.527300892207443e-04 5.145598750800573e-04 ;0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 3.076356095014504e-01 2.313538281011168e-01 0.000000000000000e+00 0.000000000000000e+00 2.448542199815687e-01 2.161563424158630e-01 ;0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 0.000000000000000e+00 7.978721777386914e-02 3.280202635750626e-01 2.202698844087719e-01 2.679675161929947e-04 3.582713067790022e-02 1.735259013296460e-01 1.617767879987032e-01 5.248467198530327e-04 ];

% Source mesh areas
Js = [3.332838956066429e-06 1.869587123839295e-05 2.197603329768755e-05 4.799382615449530e-06 1.673298410803372e-05 9.382337622467892e-05 1.102285756163840e-04 2.406782377387224e-05 1.684106091229816e-05 9.435735643913041e-05 1.107558135654748e-04 2.417309235926990e-05 3.381166588967116e-06 1.893463884278597e-05 2.221177310281562e-05 4.846448681966917e-06 ];

% Target mesh areas
Jt = [2.853788211783261e-04 1.784830949820761e-04 1.969481513727744e-05 1.056015050259953e-04 ];

% Least squares constraints
% Consistency (rowsums):
%    All rows must sum to 1
% Conservation (colsums):
%    Target-grid area weighted columns must sum to source grid area
nrows = size(a,1);
ncols = size(a,2);

a2 = reshape(a', [nrows*ncols 1]);

rowsums = zeros(nrows, nrows*ncols);
for i = 1:nrows
    rowsums(i,ncols*(i-1)+1:ncols*i) = 1;
end

colsums = zeros(ncols, nrows*ncols);
for i = 1:ncols
    for j = 1:nrows
        colsums(i,(j-1)*ncols+i) = Jt(j);
    end
end

% Solve the least squares system
x = lsqlin(eye(nrows*ncols), a2, -eye(nrows*ncols), zeros(1,nrows*ncols), [rowsums; colsums], [ones(nrows,1); Js']);
%x = lsqlin(eye(nrows*ncols), a2, [], [], [rowsums; colsums], [ones(nrows,1); Js']);
%x = lsqlin(eye(nrows*ncols), a2, [], [], [colsums], [ Js']);

x;